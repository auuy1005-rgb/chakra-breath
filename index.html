<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>æ—¥æ–‡å­¸ç¿’å¡ç‰‡ï½œMaLana</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f4f4f7;
        color: #222;
      }

      .app-header {
        padding: 1.2rem 1.5rem;
        background: #303f9f;
        color: #fff;
      }

      .app-header h1 {
        margin: 0 0 0.25rem;
        font-size: 1.4rem;
      }

      .app-main {
        max-width: 800px;
        margin: 1.5rem auto;
        padding: 0 1rem 2rem;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-bottom: 1rem;
      }

      .controls select,
      .controls button {
        padding: 0.4rem 0.6rem;
        font-size: 0.95rem;
      }

      .card {
        background: #fff;
        border-radius: 12px;
        padding: 1.2rem 1.4rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        margin-bottom: 1rem;
      }

      .card-lesson {
        font-size: 0.85rem;
        color: #666;
      }

      .card-type {
        font-size: 0.8rem;
        color: #999;
        margin-bottom: 0.5rem;
      }

      .card-jp {
        font-size: 1.6rem;
        margin-bottom: 0.4rem;
      }

      .card-kana {
        font-size: 1.1rem;
        color: #555;
        margin-bottom: 0.2rem;
      }

      .card-romaji {
        font-size: 0.95rem;
        color: #777;
        margin-bottom: 0.3rem;
      }

      .card-zh {
        font-size: 1rem;
        margin-bottom: 0.3rem;
      }

      .card-note {
        font-size: 0.85rem;
        color: #888;
        margin-bottom: 0.6rem;
      }

      .card-actions {
        margin-bottom: 0.6rem;
      }

      .card-actions button {
        padding: 0.35rem 0.8rem;
        font-size: 0.9rem;
      }

      .card-stars {
        font-size: 0.9rem;
      }

      .card-stars .star {
        cursor: pointer;
        font-size: 1.2rem;
        margin-left: 0.2rem;
        color: #ccc;
      }

      .card-stars .star.active {
        color: #ffb300;
      }

      .progress {
        font-size: 0.9rem;
        color: #555;
      }

      #cycleStatus {
        margin-top: 0.3rem;
        font-weight: 600;
      }

      .app-footer {
        text-align: center;
        padding: 0.8rem 1rem 1.2rem;
        font-size: 0.75rem;
        color: #777;
      }

      @media (max-width: 480px) {
        .card-jp {
          font-size: 1.4rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <h1>æ—¥æ–‡å­¸ç¿’å¡ç‰‡</h1>
      <p>éš¨æ©ŸæŠ½å¡ï¼‹æ˜Ÿæ˜Ÿé›£åº¦ï¼‹ç™¼éŸ³ ğŸ”Š</p>
    </header>

    <main class="app-main">
      <section class="controls">
        <label>
          é¸æ“‡èª²ç¨‹ï¼š
          <select id="lessonSelect">
            <option value="all">å…¨éƒ¨èª²ç¨‹ï¼ˆéš¨æ©Ÿï¼‰</option>
          </select>
        </label>

        <button id="nextBtn">æŠ½ä¸‹ä¸€å¼µå¡ç‰‡ ğŸ´</button>
        <button id="resetCycleBtn">é‡è¨­å­¸ç¿’å¾ªç’°</button>
      </section>

      <section class="card" id="card">
        <div class="card-lesson" id="cardLesson"></div>
        <div class="card-type" id="cardType"></div>

        <div class="card-jp" id="cardJp">è«‹å…ˆæŒ‰ã€ŒæŠ½ä¸‹ä¸€å¼µå¡ç‰‡ã€</div>
        <div class="card-kana" id="cardKana"></div>
        <div class="card-romaji" id="cardRomaji"></div>
        <div class="card-zh" id="cardZh"></div>
        <div class="card-note" id="cardNote"></div>

        <div class="card-actions">
          <button id="audioBtn">ğŸ”Š ç™¼éŸ³</button>
        </div>

        <div class="card-stars">
          é›£åº¦ï¼ˆæ˜Ÿæ˜Ÿè¶Šå¤šè¶Šå¸¸å‡ºç¾ï¼‰ï¼š
          <span class="star" data-star="1">â˜…</span>
          <span class="star" data-star="2">â˜…</span>
          <span class="star" data-star="3">â˜…</span>
        </div>
      </section>

      <section class="progress">
        <div id="cycleProgressText">æœ¬å¾ªç’°é€²åº¦ï¼š0 / 0</div>
        <div id="cycleStatus"></div>
      </section>
    </main>

    <footer class="app-footer">
      <small>å­¸ç¿’ç´€éŒ„å­˜åœ¨ç€è¦½å™¨ localStorageï¼Œä¸æœƒè¢«æ´—æ‰ âœ¨</small>
    </footer>

    <!-- ====== é€™ä¸€æ®µï¼šä½ åªéœ€è¦æ”¹ã€Œlessonsã€çš„å…§å®¹ ====== -->
    <script>
      // âœ… æ‰€æœ‰èª²ç¨‹å…§å®¹éƒ½å¯«åœ¨é€™å€‹é™£åˆ—è£¡
      // è¦æ–°å¢ç¬¬2èª²ã€ç¬¬3èª²ï¼Œåªè¦ç…§è‘—è¤‡è£½ä¸€ä»½æ”¹å…§å®¹å°±å¥½
      // æ¯å¼µå¡ç‰‡ä¸ç”¨è‡ªå·±çµ¦ idï¼Œç³»çµ±æœƒè‡ªå‹•å¹«ä½ ç·¨

      const lessons = [
        {
          lessonId: 1,
          title: "ç¬¬1èª²ï½œãªã«ã‚’ã—ã¦ã„ã¾ã™ã‹",
          cards: [
            {
              type: "sentence",
              jp: "ãªã«ã‚’ã—ã¦ã„ã‚‹ã®ï¼Ÿ",
              kana: "ãªã«ã‚’ã—ã¦ã„ã‚‹ã®ï¼Ÿ",
              romaji: "Nani o shite iru no?",
              zh: "ä½ åœ¨åšä»€éº¼ï¼Ÿ",
              note: "å£èªå½¢ï¼Œè·Ÿæœ‹å‹ç”¨",
              audioText: "ãªã«ã‚’ã—ã¦ã„ã‚‹ã®ï¼Ÿ"
            },
            {
              type: "sentence",
              jp: "ãªã«ã‚’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
              kana: "ãªã«ã‚’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
              romaji: "Nani o shite imasu ka?",
              zh: "æ‚¨åœ¨åšä»€éº¼ï¼Ÿï¼ˆè¼ƒå®¢æ°£ï¼‰",
              note: "æ•¬èªç‰ˆæœ¬",
              audioText: "ãªã«ã‚’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ"
            },
            {
              type: "word",
              jp: "æœé£Ÿ",
              kana: "ã¡ã‚‡ã†ã—ã‚‡ã",
              romaji: "choushoku",
              zh: "æ—©é¤",
              note: "",
              audioText: "ã¡ã‚‡ã†ã—ã‚‡ã"
            },
            {
              type: "sentence",
              jp: "æœé£Ÿ(ã¡ã‚‡ã†ã—ã‚‡ã)ã‚’é£Ÿã¹ã¦ã„ã¾ã™ã€‚",
              kana: "ã¡ã‚‡ã†ã—ã‚‡ãã‚’ãŸã¹ã¦ã„ã¾ã™ã€‚",
              romaji: "Choushoku o tabete imasu.",
              zh: "æˆ‘æ­£åœ¨åƒæ—©é¤ã€‚",
              note: "",
              audioText: "æœé£Ÿã‚’é£Ÿã¹ã¦ã„ã¾ã™ã€‚"
            },
            {
              type: "sentence",
              jp: "æœ¬(ã»ã‚“)ã‚’èª­(ã‚ˆ)ã‚“ã§ã„ã¾ã™ã€‚",
              kana: "ã»ã‚“ã‚’ã‚ˆã‚“ã§ã„ã¾ã™ã€‚",
              romaji: "Hon o yonde imasu.",
              zh: "æ­£åœ¨çœ‹æ›¸ã€‚",
              note: "",
              audioText: "æœ¬ã‚’èª­ã‚“ã§ã„ã¾ã™ã€‚"
            },
            {
              type: "sentence",
              jp: "æ°´(ã¿ãš)ã‚’é£²(ã®)ã‚“ã§ã„ã¾ã™ã€‚",
              kana: "ã¿ãšã‚’ã®ã‚“ã§ã„ã¾ã™ã€‚",
              romaji: "Mizu o nonde imasu.",
              zh: "æ­£åœ¨å–æ°´ã€‚",
              note: "",
              audioText: "æ°´ã‚’é£²ã‚“ã§ã„ã¾ã™ã€‚"
            },
            {
              type: "sentence",
              jp: "çŠ¬(ã„ã¬)ã¨éŠ(ã‚ã)ã‚“ã§ã„ã¾ã™ã€‚",
              kana: "ã„ã¬ã¨ã‚ãã‚“ã§ã„ã¾ã™ã€‚",
              romaji: "Inu to asonde imasu.",
              zh: "æ­£åœ¨é™ªç‹—ç©ã€‚",
              note: "",
              audioText: "çŠ¬ã¨éŠã‚“ã§ã„ã¾ã™ã€‚"
            }
          ]
        }
        ,{
  lessonId: 2,
  title: "ç¬¬2èª²ï½œãªã«ã‚’ã—ã¦ã„ã¾ã™ã‹ï¼ˆãŸã¹ã¦ã„ã¾ã™ï¼‰",
  cards: [
    {
      type: "sentence",
      jp: "æœé£Ÿ(ã‚ã•ã”ã¯ã‚“)ã‚’é£Ÿ(ãŸ)ã¹ã¦ã„ã¾ã™ã€‚",
      kana: "ã‚ã•ã”ã¯ã‚“ã‚’ãŸã¹ã¦ã„ã¾ã™ã€‚",
      romaji: "Asagohan o tabete imasu.",
      zh: "æˆ‘æ­£åœ¨åƒæ—©é¤ã€‚",
      note: "",
      audioText: "æœé£Ÿã‚’é£Ÿã¹ã¦ã„ã¾ã™ã€‚"
    },
    {
      type: "sentence",
      jp: "ãƒãƒŠãƒŠã‚’é£Ÿ(ãŸ)ã¹ã¦ã„ã¾ã™ã€‚",
      kana: "ã°ãªãªã‚’ãŸã¹ã¦ã„ã¾ã™ã€‚",
      romaji: "Banana o tabete imasu.",
      zh: "æ­£åœ¨åƒé¦™è•‰ã€‚",
      note: "",
      audioText: "ãƒãƒŠãƒŠã‚’é£Ÿã¹ã¦ã„ã¾ã™ã€‚"
    },
    {
      type: "sentence",
      jp: "æ˜¼é£Ÿ(ã¡ã‚…ã†ã—ã‚‡ã)ã‚’é£Ÿ(ãŸ)ã¹ã¦ã„ã¾ã™ã€‚",
      kana: "ã¡ã‚…ã†ã—ã‚‡ãã‚’ãŸã¹ã¦ã„ã¾ã™ã€‚",
      romaji: "Chuushoku o tabete imasu.",
      zh: "æ­£åœ¨åƒåˆé¤ã€‚",
      note: "",
      audioText: "æ˜¼é£Ÿã‚’é£Ÿã¹ã¦ã„ã¾ã™ã€‚"
    },
    {
      type: "sentence",
      jp: "é‡èœ(ã‚„ã•ã„)ã‚’é£Ÿ(ãŸ)ã¹ã¦ã„ã¾ã™ã€‚",
      kana: "ã‚„ã•ã„ã‚’ãŸã¹ã¦ã„ã¾ã™ã€‚",
      romaji: "Yasai o tabete imasu.",
      zh: "æ­£åœ¨åƒè”¬èœã€‚",
      note: "",
      audioText: "é‡èœã‚’é£Ÿã¹ã¦ã„ã¾ã™ã€‚"
    },
    {
      type: "sentence",
      jp: "ã‚Šã‚“ã”ã‚’é£Ÿ(ãŸ)ã¹ã¦ã„ã¾ã™ã€‚",
      kana: "ã‚Šã‚“ã”ã‚’ãŸã¹ã¦ã„ã¾ã™ã€‚",
      romaji: "Ringo o tabete imasu.",
      zh: "æ­£åœ¨åƒè˜‹æœã€‚",
      note: "",
      audioText: "ã‚Šã‚“ã”ã‚’é£Ÿã¹ã¦ã„ã¾ã™ã€‚"
    }
  ]
}

 
        // ğŸš€ ä¹‹å¾Œè¦æ–°å¢ç¬¬2èª²ï¼Œå°±åƒé€™æ¨£è¤‡è£½ä¸€ä»½æ”¹å…§å®¹ï¼ˆç¯„ä¾‹ï¼‰ï¼š
        /*
        ,{
          lessonId: 2,
          title: "ç¬¬2èª²ï½œXXXX",
          cards: [
            {
              type: "sentence",
              jp: "XXXX",
              kana: "XXXX",
              romaji: "XXXX",
              zh: "ä¸­æ–‡æ„æ€",
              note: "",
              audioText: "XXXX"
            },
            {
              type: "word",
              jp: "å–®å­—ä¾‹å­",
              kana: "ã‹ãªã‚Œã„ã˜",
              romaji: "kana reiji",
              zh: "å–®å­—ä¸­æ–‡",
              note: "",
              audioText: "å–®å­—ä¾‹å­"
            }
          ]
        }
        */
      ];
    </script>

    <!-- ====== ä¸‹é¢é€™æ®µç¨‹å¼ä¸ç”¨æ”¹ï¼Œè² è²¬éš¨æ©ŸæŠ½å¡ / æ˜Ÿæ˜Ÿæ¬Šé‡ / å¾ªç’° / ç™¼éŸ³ ====== -->
    <script>
      const STORAGE_KEY = "jpStudyState_v1";

      let state = {
        cardDifficulty: {}, // { uid: 0~3 }
        cycleSeen: {} // { uid: true }
      };

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            state = {
              cardDifficulty: parsed.cardDifficulty || {},
              cycleSeen: parsed.cycleSeen || {}
            };
          }
        } catch (e) {
          console.warn("è®€å–ç‹€æ…‹å¤±æ•—ï¼Œä½¿ç”¨é è¨­", e);
        }
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      // æŠŠæ‰€æœ‰å¡ç‰‡æ•´ç†æˆä¸€å€‹ flat é™£åˆ—ï¼Œé †ä¾¿è‡ªå‹•çµ¦ uid
      const allCards = [];
      lessons.forEach((lesson) => {
        lesson.cards.forEach((card, index) => {
          const uid = `${lesson.lessonId}-${index + 1}`;
          allCards.push({
            ...card,
            lessonId: lesson.lessonId,
            lessonTitle: lesson.title,
            uid
          });
        });
      });

      // DOM
      const lessonSelect = document.getElementById("lessonSelect");
      const nextBtn = document.getElementById("nextBtn");
      const resetCycleBtn = document.getElementById("resetCycleBtn");

      const cardLesson = document.getElementById("cardLesson");
      const cardType = document.getElementById("cardType");
      const cardJp = document.getElementById("cardJp");
      const cardKana = document.getElementById("cardKana");
      const cardRomaji = document.getElementById("cardRomaji");
      const cardZh = document.getElementById("cardZh");
      const cardNote = document.getElementById("cardNote");
      const cycleProgressText = document.getElementById("cycleProgressText");
      const cycleStatus = document.getElementById("cycleStatus");
      const audioBtn = document.getElementById("audioBtn");
      const starElems = Array.from(document.querySelectorAll(".card-stars .star"));

      let currentCard = null;

      function initLessonSelect() {
        lessons.forEach((lesson) => {
          const opt = document.createElement("option");
          opt.value = String(lesson.lessonId);
          opt.textContent = lesson.title;
          lessonSelect.appendChild(opt);
        });
      }

      function getCurrentPool() {
        const value = lessonSelect.value;
        if (value === "all") return allCards;
        const lessonId = Number(value);
        return allCards.filter((c) => c.lessonId === lessonId);
      }

      // æ¬Šé‡æŠ½å¡
      function pickRandomCard() {
        const pool = getCurrentPool();
        if (pool.length === 0) return null;

        const weights = [];
        let totalWeight = 0;

        pool.forEach((card) => {
          const difficulty = state.cardDifficulty[card.uid] || 0; // 0~3
          let weight = 1 + difficulty * 1.5;

          if (!state.cycleSeen[card.uid]) {
            weight += 2; // é€™è¼ªé‚„æ²’å‡ºç¾éï¼Œå„ªå…ˆ
          }

          weights.push({ card, weight });
          totalWeight += weight;
        });

        let r = Math.random() * totalWeight;
        for (const w of weights) {
          if (r < w.weight) return w.card;
          r -= w.weight;
        }
        return weights[weights.length - 1].card;
      }

      function updateCardUI(card) {
        if (!card) {
          cardLesson.textContent = "";
          cardType.textContent = "";
          cardJp.textContent = "æ²’æœ‰å¡ç‰‡";
          cardKana.textContent = "";
          cardRomaji.textContent = "";
          cardZh.textContent = "";
          cardNote.textContent = "";
          starElems.forEach((el) => el.classList.remove("active"));
          return;
        }

        cardLesson.textContent = card.lessonTitle;
        cardType.textContent = card.type === "word" ? "ã€å–®å­—ã€‘" : "ã€å¥å­ã€‘";
        cardJp.textContent = card.jp;
        cardKana.textContent = card.kana || "";
        cardRomaji.textContent = card.romaji || "";
        cardZh.textContent = card.zh || "";
        cardNote.textContent = card.note || "";

        const stars = state.cardDifficulty[card.uid] || 0;
        starElems.forEach((el) => {
          const s = Number(el.dataset.star);
          if (s <= stars) el.classList.add("active");
          else el.classList.remove("active");
        });

        // æ¨™è¨˜ç‚ºé€™è¼ªå·²ç¶“å‡ºç¾
        state.cycleSeen[card.uid] = true;
        saveState();
        updateProgressUI();
      }

      function updateProgressUI() {
        const pool = getCurrentPool();
        const total = pool.length;
        const seenCount = pool.filter((c) => state.cycleSeen[c.uid]).length;
        cycleProgressText.textContent = `æœ¬å¾ªç’°é€²åº¦ï¼š${seenCount} / ${total}`;

        if (total > 0 && seenCount === total) {
          cycleStatus.textContent =
            "âœ… é€™å€‹ç¯„åœè£¡çš„å¡ç‰‡æœ¬è¼ªéƒ½çœ‹éå›‰ï¼Œå¯ä»¥é‡è¨­å¾ªç’°æˆ–æ”¹åˆ¥çš„èª²ã€‚";
        } else {
          cycleStatus.textContent = "";
        }
      }

      // äº‹ä»¶
      nextBtn.addEventListener("click", () => {
        const card = pickRandomCard();
        currentCard = card;
        updateCardUI(card);
      });

      resetCycleBtn.addEventListener("click", () => {
        state.cycleSeen = {};
        saveState();
        updateProgressUI();
      });

      lessonSelect.addEventListener("change", () => {
        updateProgressUI();
      });

      starElems.forEach((el) => {
        el.addEventListener("click", () => {
          if (!currentCard) return;
          const starValue = Number(el.dataset.star);
          const current = state.cardDifficulty[currentCard.uid] || 0;
          const newValue = current === starValue ? 0 : starValue; // å†é»åŒä¸€é¡†å°±æ­¸é›¶
          state.cardDifficulty[currentCard.uid] = newValue;
          saveState();
          updateCardUI(currentCard);
        });
      });

      audioBtn.addEventListener("click", () => {
        if (!currentCard) return;
        if (!("speechSynthesis" in window)) {
          alert("é€™å€‹ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³ç™¼éŸ³ ğŸ˜­");
          return;
        }
        const utterance = new SpeechSynthesisUtterance(
          currentCard.audioText || currentCard.jp
        );
        utterance.lang = "ja-JP";
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
      });

      // å•Ÿå‹•
      loadState();
      initLessonSelect();
      updateProgressUI();
    </script>
  </body>
</html>

